# Prisma Migrations for Autopay Agent

This document outlines the Prisma migration strategy and history for the Autopay Agent project, which implements autonomous x402 payment flows on Solana Devnet. The database schema supports core functionalities such as transaction auditing, payment retry tracking, balance monitoring, and session management for Phantom Wallet integrations. We use PostgreSQL as the underlying database with Prisma ORM for type-safe migrations and queries.

The schema is designed to ensure resilience in decentralized environments: all tables include audit fields (e.g., timestamps, status enums) to log the agent's interactions with premium APIs (Market Data API and Knowledge Data API), Solana transactions via Phantom CASH/USDC, and Coinbase Facilitator verifications. Migrations are incremental, focusing on extensibility for multi-API monitoring in Phase 3 autonomy.

**Key Design Principles:**
- **Immutability for Audits:** Transaction and log tables use append-only patterns to maintain a tamper-proof ledger, replacing the initial local JSON ledger for scalability.
- **Indexing for Performance:** Composite indexes on transaction hashes, timestamps, and agent IDs to support real-time queries in the Next.js frontend visualization.
- **Security Compliance:** Sensitive fields (e.g., session tokens) are encrypted at the application level (AES-256) before storage; no raw private keys are persisted.
- **Devnet Isolation:** All data is scoped to Solana Devnet; a `network` enum distinguishes environments.
- **Error Handling Integration:** Tables track retry attempts, failures (e.g., insufficient funds, RPC issues), and circuit-breaker states for non-blocking resilience.

Migrations are generated using `npx prisma migrate dev` and applied via `npx prisma db push` for production. The Prisma schema (`schema.prisma`) defines the models, with migrations stored in `prisma/migrations/`.

## Migration History

### Migration 001: Initial Schema Setup (Timestamp: 2024-01-15_000001_initial_autopay_schema)
**Description:** Establishes foundational tables for agent operations, transaction logging, and basic balance tracking. This migration sets up the core audit trail to capture 402 response detections, payment executions, and API retries. It includes enums for status tracking aligned with x402 flows.

**Changes:**
- Created `Agent` model: Stores autonomous agent configurations (e.g., autonomy phase: DEMO, INTERACTIVE, FULL; API endpoints monitored like `/api/market-feed` or AI insights).
  - Fields: `id` (UUID PK), `name` (string, e.g., "MarketDataAgent"), `autonomyPhase` (enum: ['DEMO', 'INTERACTIVE', 'FULL']), `walletAddress` (string, Phantom public key), `createdAt` (timestamp), `updatedAt` (timestamp).
- Created `Transaction` model: Logs all Solana payments (Phantom CASH/USDC) and verifications via Coinbase Facilitator API.
  - Fields: `id` (UUID PK), `agentId` (FK to Agent), `hash` (string, unique Solana tx hash), `amount` (decimal, in lamports or USDC units), `currency` (enum: ['CASH', 'USDC']), `status` (enum: ['PENDING', 'SUCCESS', 'FAILED', 'RETRYING', 'VERIFIED']), `x402RequestId` (string, from 402 header), `facilitatorResponse` (JSONB, for WebSocket callbacks), `retryCount` (int, max 3), `errorType` (enum: ['INSUFFICIENT_FUNDS', 'NETWORK_FAILURE', 'REJECTED', 'RPC_ERROR']), `network` (enum: ['DEVNET', 'MAINNET']), `createdAt` (timestamp).
  - Indexes: Unique on `hash` + `network`; composite on `agentId` + `createdAt` for agent-specific timelines.
- Created `BalanceSnapshot` model: Real-time monitoring of agent wallet balances to trigger low-balance events.
  - Fields: `id` (UUID PK), `agentId` (FK to Agent), `balance` (decimal), `currency` (enum: ['CASH', 'USDC']), `threshold` (decimal, e.g., 0.01 USDC for pause), `status` (enum: ['SUFFICIENT', 'LOW', 'PAUSED']), `snapshotAt` (timestamp).
  - Indexes: On `agentId` + `snapshotAt` for historical queries.
- Created `ApiRequestLog` model: Tracks 402 detections, retries, and data access post-payment for Market Data (crypto prices, arbitrage) and Knowledge Data APIs.
  - Fields: `id` (UUID PK), `agentId` (FK to Agent), `endpoint` (string, e.g., "/api/market-feed"), `method` (enum: ['GET', 'POST']), `responseStatus` (int, e.g., 402), `x402Instructions` (JSONB, parsed payment details), `retryAttempts` (int), `successPayload` (JSONB, premium data on retry success), `transactionId` (FK to Transaction, optional), `createdAt` (timestamp).
  - Indexes: On `agentId` + `endpoint` for API-specific analytics.

**Rationale:** This baseline supports Phase 1 (demo mode) logging without over-engineering. Total tables: 4. Estimated schema size: ~10KB initial.

**SQL Snippet (Generated by Prisma):**
```sql
CREATE TYPE "AutonomyPhase" AS ENUM ('DEMO', 'INTERACTIVE', 'FULL');
CREATE TYPE "Currency" AS ENUM ('CASH', 'USDC');
CREATE TYPE "TransactionStatus" AS ENUM ('PENDING', 'SUCCESS', 'FAILED', 'RETRYING', 'VERIFIED');
-- Additional enums for ErrorType, Network, etc.
CREATE TABLE "Agent" (
    "id" UUID NOT NULL PRIMARY KEY,
    "name" TEXT NOT NULL,
    "autonomyPhase" "AutonomyPhase" NOT NULL,
    "walletAddress" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP
);
-- Similar for other tables...
CREATE INDEX "Transaction_hash_network" ON "Transaction"("hash", "network");
```

### Migration 002: Add Session Management and Retry Enhancements (Timestamp: 2024-01-20_000002_session_and_retry)
**Description:** Introduces secure session handling for Phantom Wallet delegation (time/scope-limited keys) and enhances retry logic with exponential backoff tracking. This aligns with security requirements: scoped permissions, AES-256 encryption (handled in app code), and Devnet isolation.

**Changes:**
- Added `Session` model: Manages Phantom session keys for autonomous signing (e.g., valid for 1 hour or 3 txs).
  - Fields: `id` (UUID PK), `agentId` (FK to Agent), `sessionToken` (string, encrypted), `scope` (JSONB, e.g., {"txLimit": 3, "duration": 3600}), `status` (enum: ['ACTIVE', 'EXPIRED', 'REVOKED']), `expiresAt` (timestamp), `createdAt` (timestamp).
  - Indexes: On `agentId` + `expiresAt` for cleanup queries.
- Updated `Transaction` model: Added `backoffDelay` (int, milliseconds for exponential retry) and `sessionId` (FK to Session).
- Updated `ApiRequestLog` model: Added `circuitBreakerState` (enum: ['OPEN', 'CLOSED', 'HALF_OPEN']) for network/RPC resilience.
- Added foreign key constraints and cascading deletes for sessions on agent removal.

**Rationale:** Supports Phase 2 (interactive mode) with browser-based delegation. Introduces circuit-breaker data for queued payments during RPC failures, ensuring non-blocking autonomy.

**Rollback Considerations:** If needed, drop `Session` table and revert FK additions; use `npx prisma migrate reset` in dev.

### Migration 003: Multi-API Prioritization and Audit Extensions (Timestamp: 2024-01-25_000003_multi_api_priority)
**Description:** Extends schema for Phase 3 full autonomy: prioritizes API requests based on funds and data freshness. Adds comprehensive audit views for frontend visualization (e.g., payment flows, on-chain status).

**Changes:**
- Updated `Agent` model: Added `priorityRules` (JSONB, e.g., {"fundsThreshold": 0.05, "freshnessWindow": 300} for multi-API scheduling).
- Created `PriorityQueue` model: Queues pending requests during low balance or network issues.
  - Fields: `id` (UUID PK), `agentId` (FK to Agent), `apiRequestId` (FK to ApiRequestLog), `priorityScore` (decimal, calculated from balance/freshness), `queuedAt` (timestamp), `processedAt` (timestamp, nullable).
  - Indexes: On `agentId` + `priorityScore` for efficient dequeuing.
- Added database view `AuditTrailView`: Joins Transaction, ApiRequestLog, and BalanceSnapshot for a unified ledger query (e.g., `SELECT * FROM "AuditTrailView" WHERE agentId = ? ORDER BY createdAt DESC`).
  - View SQL: Combines logs for transparency, simulating the JSON ledger but queryable.
- Added `verificationHash` (string) to Transaction for Coinbase Facilitator cross-checks.

**Rationale:** Enables machine-to-machine economy demos by storing prioritization logic. The view supports BackendDev APIs for real-time frontend updates via Next.js (e.g., Zustand state sync).

**Performance Notes:** Views are non-materialized for simplicity; monitor query times with EXPLAIN ANALYZE. Estimated impact: +15% schema size.

## Running Migrations

### Development Workflow
1. Install dependencies: `npm install prisma @prisma/client`.
2. Generate initial schema: `npx prisma generate`.
3. Create and apply migration: `npx prisma migrate dev --name <description>`.
4. Seed test data (e.g., demo agent for Market Data API): `npx prisma db seed`.
5. Studio for inspection: `npx prisma studio`.

### Production Deployment
- Use `npx prisma migrate deploy` in CI/CD (e.g., Vercel or Render hooks).
- Environment vars: `DATABASE_URL` (PostgreSQL connection string, e.g., `postgresql://user:pass@host:5432/autopay_db?schema=public`).
- Migrations run on Dockerized PostgreSQL (via AWS Fargate); ensure idempotency with `--force` only in emergencies.
- Backup strategy: Daily pg_dump to S3, focusing on Transaction and AuditTrailView data.

### Seeding Script Example (prisma/seed.ts)
```typescript
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // Seed demo agent for x402 flow
  await prisma.agent.create({
    data: {
      name: 'AutopayDemoAgent',
      autonomyPhase: 'DEMO',
      walletAddress: 'devnet_phantom_address_placeholder',
    },
  });
  // Add sample balance snapshot and transaction for 402 retry
  await prisma.balanceSnapshot.create({
    data: {
      agentId: 'generated-uuid',
      balance: 0.1,
      currency: 'USDC',
      status: 'SUFFICIENT',
    },
  });
}

main().catch(e => console.error(e)).finally(async () => await prisma.$disconnect());
```

## Schema Evolution Guidelines
- **Versioning:** Tag migrations with semantic versioning (e.g., v1.0.0_initial).
- **Testing:** After each migration, run Jest integration tests on BackendDev endpoints (e.g., `/api/transactions` querying Transaction table).
- **Extensibility:** Future migrations may add tables for Rust-based Solana programs (e.g., `CustomProgramLog`) or WebSocket event streams.
- **Compliance:** All changes audited in Git; no migrations alter existing data without explicit migration scripts.

For coordination: BackendDev should reference these models in NestJS/Express services for transaction CRUD. FrontendDev can consume aggregated data from AuditTrailView via secure APIs. If schema changes are needed, propose via PR with migration file.

**Last Updated:** 2024-01-28  
**Unique Identifier:** 1762841338084_autopay_agent_for_x402_autonomous_payments_on_solana__db_migrations_md_9blt9e